---
layout: post
title:  "Scanning the archive"
author: Rhys Evans
date:   2023-05-23 17:00:00 +0100
categories: search stac indexing
tags: [search, indexing, stac]
---

Our last STAC update was back in 2022 when we added [asset search]({% post_url _posts/stac/2022-02-04-asset-search %}). This post focuses on the changes we've made to the indexing framework we've created and the scan we've recently completed of the CEDA archive.

If you want to read more about our work with STAC previous STAC aticles: 
[search futures]({% post_url _posts/stac/2021-07-05-search-futures %}#background)
[stac update]({% post_url _posts/stac/2021-12-07-stac-update %}#requirements)
[asset search]({% post_url _posts/stac/2022-02-04-asset-search %}#progress)


# Index

* [Update to Indexing](#indexing-update)
* [Scanning the CEDA Archive](#scanning-the-archive)
* [Conclusion](#conclusion)

# Indexing update

Previously the code needed to create a catalog was spread across two pieces of software, the [asset-scanner](https://github.com/cedadev/asset-scanner) and the [collection generator](https://github.com/cedadev/collection-generator). Both of these followed a very similar pattern of scanning over some data, followed by metadata extraction and outputing this metadata to a database. To make the maintainance and running of the code easier these code bases have been combined into the stac-generator. The stac-generator can now be used to create all three types of STAC objects.

These changes have also lead to changes in the structur of the collection description. The desctiption is now split into three sections one for each of the STAC levels (asset, item, and collection). These section have the same structure which includes ID, extraction methods, and post extraction methods. The ID section defines how the ID should be generated. The hash method can be used to specify a list of facets to be included in the ID which allows for novel IDs for different parts of the archive. The extraction methods section defines which what facets should be extracted and the methods of extraction. Finally, post extraction methods can be used to modify the extracted facets before they are stored. For CEDA this will interactions with a vocabulary server that can check the terms are correct and link the facets to more general terms.

# Scanning the Archive

A requirement we had at the start of this project was that we could have one STAC catalog for our entire archive. To test that STAC could work at this scale and that we could generate data _quickly_ enough we set about scanning the archive. To do this we, together with our data curators, wrote an initial set of collection descriptions. All but one of these were specific to a project within the archive, such as CMIP6. The remaining collection description was written to catch all the other data (abbreviated to "ATOD"). To keep things simple and make our scan as fast as possible the ATOD collection description would initially only extract basic information from the file (size, extension, etc) and directory. To perform the initial scan of the archive we used [LOTUS](https://help.jasmin.ac.uk/article/5004-lotus-overview) which,meant we could run a set of stac generators in parallel to reduce scan time.

The scan took us around two weeks to complete and generated over 325 million assets, 4 million items and 10 collections. What we've produced is a kind of minimum viable product catalogue, with all of the generated assets, items, and collections having at least the basic file and directory metadata specified in the ATOD collection description. 

# Conclusion

This has been a great jump forward for this project giving us the cabability to search across the archive using STAC. However, our STAC catalog doesn't yet have the richness of data that the [CEDA catalogue](https://catalogue.ceda.ac.uk/) has, with only X% having domain specific metadata. We are now aiming to increase the level of dat extraction in two ways, firstly, by increasing the amount extracted within ATOD. And secondly, through reducing the proportion of the archive ATOD covers by adding more collection descriptions for specific areas.